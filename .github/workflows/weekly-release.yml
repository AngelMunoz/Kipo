name: Weekly Preview Release

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for changelog

      - name: Get Last Weekly Release Tag
        id: last_release
        shell: pwsh
        run: |
          # Find the most recent weekly-* tag
          $lastTag = git tag -l "weekly-*" --sort=-creatordate | Select-Object -First 1
          if ($lastTag) {
            echo "tag=$lastTag" >> $env:GITHUB_OUTPUT
            echo "Found last weekly release: $lastTag"
          } else {
            # If no weekly release exists, use the first commit
            $firstCommit = git rev-list --max-parents=0 HEAD
            echo "tag=$firstCommit" >> $env:GITHUB_OUTPUT
            echo "No previous weekly release found, using first commit"
          }

      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $lastTag = "${{ steps.last_release.outputs.tag }}"

          # Get merged PRs since last release
          $mergedPRs = gh pr list --state merged --base main --json number,title,url,mergedAt --limit 100 | ConvertFrom-Json

          # Filter PRs merged after the last release tag date
          $tagDate = git log -1 --format=%aI $lastTag 2>$null
          if ($tagDate) {
            $mergedPRs = $mergedPRs | Where-Object { $_.mergedAt -gt $tagDate }
          }

          # Get direct commits (non-merge commits) since last release
          $commits = git log "$lastTag..HEAD" --no-merges --pretty=format:"%h|%s|%an" | ForEach-Object {
            $parts = $_ -split '\|'
            if ($parts.Length -ge 3) {
              [PSCustomObject]@{
                Hash = $parts[0]
                Message = $parts[1]
                Author = $parts[2]
              }
            }
          } | Where-Object { $_ -ne $null }

          # Build the release notes
          $notes = @()
          $notes += "## ðŸ“… Weekly Preview Release"
          $notes += ""
          $notes += "This is an automated weekly preview release containing all changes merged to main since the last weekly build."
          $notes += ""

          # PRs section (highlights)
          if ($mergedPRs.Count -gt 0) {
            $notes += "## âœ¨ Highlights (Merged PRs)"
            $notes += ""
            foreach ($pr in $mergedPRs) {
              $notes += "- **[#$($pr.number)]($($pr.url))**: $($pr.title)"
            }
            $notes += ""
          } else {
            $notes += "## âœ¨ Highlights"
            $notes += ""
            $notes += "_No PRs were merged this week._"
            $notes += ""
          }

          # Commits section
          if ($commits.Count -gt 0) {
            $notes += "## ðŸ”§ Other Changes (Direct Commits)"
            $notes += ""
            $notes += "<details>"
            $notes += "<summary>View $($commits.Count) commit(s)</summary>"
            $notes += ""
            foreach ($commit in $commits) {
              $notes += "- ``$($commit.Hash)`` $($commit.Message) â€” _$($commit.Author)_"
            }
            $notes += ""
            $notes += "</details>"
            $notes += ""
          }

          $notes += "---"
          $notes += ""
          $notes += "> [!IMPORTANT]"
          $notes += "> These builds are **NOT self-contained**."
          $notes += "> You **MUST** have the **.NET 10 Runtime** installed to run these binaries."
          $notes += ""
          $notes += "### Assets"
          $notes += "- `Pomo-DesktopGL.zip`: Cross-platform Desktop version."
          $notes += "- `Pomo-WindowsDX.zip`: Windows-specific DirectX version."

          # Check if there are any changes at all
          $hasChanges = ($mergedPRs.Count -gt 0) -or ($commits.Count -gt 0)
          echo "has_changes=$hasChanges" >> $env:GITHUB_OUTPUT

          # Write release notes to file
          $notesText = $notes -join "`n"
          $notesText | Out-File -FilePath release_notes.md -Encoding utf8
          echo "Generated release notes with $($mergedPRs.Count) PRs and $($commits.Count) commits"

      - name: Check for Changes
        if: steps.release_notes.outputs.has_changes == 'False'
        run: |
          echo "No changes since last weekly release. Skipping."
          exit 0

      - name: Setup .NET
        if: steps.release_notes.outputs.has_changes == 'True'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Build DesktopGL
        if: steps.release_notes.outputs.has_changes == 'True'
        run: dotnet publish Pomo.DesktopGL/Pomo.DesktopGL.fsproj -c Release -o publish/DesktopGL

      - name: Build WindowsDX
        if: steps.release_notes.outputs.has_changes == 'True'
        run: dotnet publish Pomo.WindowsDX/Pomo.WindowsDX.fsproj -c Release -o publish/WindowsDX

      - name: Zip Artifacts
        if: steps.release_notes.outputs.has_changes == 'True'
        shell: pwsh
        run: |
          Compress-Archive -Path publish/DesktopGL/* -DestinationPath publish/Pomo-DesktopGL.zip
          Compress-Archive -Path publish/WindowsDX/* -DestinationPath publish/Pomo-WindowsDX.zip

      - name: Generate Timestamp
        if: steps.release_notes.outputs.has_changes == 'True'
        id: timestamp
        shell: pwsh
        run: |
          $timestamp = Get-Date -Format "dd-MM-yyyy"
          echo "value=$timestamp" >> $env:GITHUB_OUTPUT

      - name: Create Weekly Release
        if: steps.release_notes.outputs.has_changes == 'True'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: weekly-${{ steps.timestamp.outputs.value }}
          name: "Weekly Preview - ${{ steps.timestamp.outputs.value }}"
          prerelease: true
          make_latest: true
          body_path: release_notes.md
          files: |
            publish/Pomo-DesktopGL.zip
            publish/Pomo-WindowsDX.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
